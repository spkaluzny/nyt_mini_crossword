---
title: "New York Time Mini Crossword"
author: "Stephen Kaluzny"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## The Puzzle

Everyday the New York Times puts out a mini crossword.

## Setup
```{r load_packages}
if(!requireNamespace("dplyr", quietly=TRUE)) {
  install.packages("dplyr")
}
if(!requireNamespace("tidyr", quietly=TRUE)) {
  install.packages("tidyr")
}
if(!requireNamespace("ggplot2", quietly=TRUE)) {
  install.packages("ggplot2")
}
if(!requireNamespace("lubridate", quietly=TRUE)) {
  install.packages("lubridate")
}
if(!requireNamespace("here", quietly=TRUE)) {
  install.packages("here")
}
if(!requireNamespace("assertr", quietly=TRUE)) {
  install.packages("assertr")
}
library("assertr", quietly = TRUE, warn.conflicts = FALSE)
library("tidyr", quietly = TRUE, warn.conflicts = FALSE)
library("dplyr", quietly = TRUE, warn.conflicts = FALSE)
library("ggplot2", quietly = TRUE, warn.conflicts = FALSE)
```
  
## The Data

```{r read_data}
d <- read.csv(here::here("data", "nyt.csv"), stringsAsFactors=FALSE)
```

Convert to dates, time-of-day and seconds
```{r date_time}
d$DateTime <- as.POSIXct(with(d,
  paste(Date, ifelse(is.na(TimeOfDay), "00:00", TimeOfDay))))
d$WeekDay <- lubridate::wday(d$DateTime)
d$Date <- as.Date(d$Date)
d$Seconds <- with(d, as.numeric(lubridate::seconds(lubridate::ms(Time))))
```

### Data Quality Check

New data is regularly added to the CSV data file.
In this section we do a quality check on the data to make sure no
data entry errors have occurred.

First, set some values that are expected in the data:

```{r data_verification_0}
# Current list of players:
players <- c("SPK", "JAK", "JIK", "BBK", "SKK")
# Earliest date:
first_date <- as.Date("2017-09-25")
# Upper bound on time (10 minutes = 600 seconds):
time_bound <- 600
```

Check that Player is one of 5 possible values:
```{r data_verification_1}
d %>% assert(in_set(players), Player) %>% success_logical()
```

There should be no missing values in the data:
```{r data_verification_2}
d %>% assert(not_na, DateTime, WeekDay, Seconds) %>% success_logical()
```

Only one observation per player per date:
```{r data_verification_3}
d %>% group_by(Date) %>% count(Player) %>% verify(n == 1) %>% success_logical()
```

Check for proper time values:
```{r data_verification_4}
d %>% assertr::verify(Seconds > 0 & Seconds < time_bound) %>% success_logical()
```

Check range of dates
```{r data_verification_5}
first_date <- as.Date("2017-09-25")
today <- Sys.Date()
d %>% 
  assertr::verify(Date >= first_date & Date <= today) %>% success_logical()
```

## Summary Statistics

Current data set has `r nrow(d)` observations.

```{r summary}
d %>% group_by(Player) %>%
  summarise(Mean = mean(Seconds), Median = median(Seconds), Min = min(Seconds), Max = max(Seconds), N=n())
```

## Subset the Data

Subset the data by only working with observations from
`SPK`, `JAK` and `JIK`.
Other players do not have enough observations to analyze.

```{r subset}
d <- d %>%
  filter(Player %in% c("SPK", "JAK", "JIK"))
```

Now have `r nrow(d)` observations.

## Plots

An Initial plot of the data.

```{r plot01, echo=FALSE}
d %>%
  ggplot(aes(x=WeekDay, y=Seconds)) +
    geom_jitter(position = position_jitter(width=.3)) +
    ggtitle("Time vs Day of the Week")
```

Same plot with player identified.

```{r plot02, echo=FALSE}
d %>%
  ggplot(aes(x=WeekDay, y=Seconds, color=Player)) +
    geom_point() +
    ggtitle("Time vs Day of the Week")
```

The distribution of the times, summarised in a boxplot:

```{r plot03, echo=FALSE}
d %>%
  ggplot(aes(x=WeekDay, y=Seconds, group=WeekDay)) +
    geom_boxplot() +
    ggtitle("Time vs Day of the Week")
```

```{r spread01, eval=FALSE}
spkjak <- function(x) {
  m <- match(c("SPK","JAK"), x, nomatch=-1)
  if(all(m > 0)) {
      "SPKJAK"
  } else {
      NA
  }
}
d2 <- group_by(d, Date) %>%
  mutate(SPKJAK = spkjak(Player)) %>%
  ungroup() %>%
  filter(SPKJAK == "SPKJAK")
```
```{r spread02, eval=FALSE}
d3 <- d2 %>% select(Date, Player, Seconds) %>%
  group_by(Date) %>%
  spread(key=Player, value=Seconds) %>%
  ungroup()
```
